const sw=self,VERSION=2,resourceCacheName=`vscode-resource-cache-${VERSION}`,rootPath=sw.location.pathname.replace(/\/service-worker.js$/,""),searchParams=new URL(location.toString()).searchParams,resourceBaseAuthority=searchParams.get("vscode-resource-base-authority"),resolveTimeout=3e4;class RequestStore{constructor(){this.map=new Map,this.requestPool=0}get(e){const o=this.map.get(e);return o&&o.promise}create(){const e=++this.requestPool;let o;const n=new Promise(a=>o=a),r={resolve:o,promise:n};this.map.set(e,r);const l=setTimeout(()=>{if(clearTimeout(l),this.map.get(e)===r)return this.map.delete(e)},resolveTimeout);return{requestId:e,promise:n}}resolve(e,o){const n=this.map.get(e);return n?(n.resolve(o),this.map.delete(e),!0):!1}}const resourceRequestStore=new RequestStore,localhostRequestStore=new RequestStore,notFound=()=>new Response("Not Found",{status:404});sw.addEventListener("message",async t=>{switch(t.data.channel){case"version":{const e=t.source;sw.clients.get(e.id).then(o=>{o&&o.postMessage({channel:"version",version:VERSION})});return}case"did-load-resource":{let e;const o=t.data.data;switch(o.status){case 200:{e={type:"response",body:o.data,mime:o.mime,etag:o.etag};break}case 304:{e={type:"not-modified",mime:o.mime};break}}resourceRequestStore.resolve(o.id,e)||console.log("Could not resolve unknown resource",o.path);return}case"did-load-localhost":{const e=t.data.data;localhostRequestStore.resolve(e.id,e.location)||console.log("Could not resolve unknown localhost",e.origin);return}}console.log("Unknown message")}),sw.addEventListener("fetch",t=>{const e=new URL(t.request.url);if(e.protocol==="https:"&&e.hostname.endsWith("."+resourceBaseAuthority))return t.respondWith(processResourceRequest(t,e));if(e.origin!==sw.origin&&e.host.match(/^(localhost|127.0.0.1|0.0.0.0):(\d+)$/))return t.respondWith(processLocalhostRequest(t,e))}),sw.addEventListener("install",t=>{t.waitUntil(sw.skipWaiting())}),sw.addEventListener("activate",t=>{t.waitUntil(sw.clients.claim())});async function processResourceRequest(t,e){const o=await sw.clients.get(t.clientId);if(!o)return console.error("Could not find inner client for request"),notFound();const n=getWebviewIdForClient(o);if(!n)return console.error("Could not resolve webview id"),notFound();async function r(s,m){if(!s)return notFound();if(s.type==="not-modified"){if(m)return m.clone();throw new Error("No cache found")}const d={"Content-Type":s.mime,"Access-Control-Allow-Origin":"*"};s.etag&&(d.ETag=s.etag,d["Cache-Control"]="no-cache");const f=new Response(s.body,{status:200,headers:d});return s.etag&&caches.open(resourceCacheName).then(w=>w.put(t.request,f)),f.clone()}const i=await getOuterIframeClient(n);if(!i.length)return console.log("Could not find parent client for request"),notFound();const a=await(await caches.open(resourceCacheName)).match(t.request),{requestId:h,promise:c}=resourceRequestStore.create(),u=e.hostname.slice(0,e.hostname.length-(resourceBaseAuthority.length+1)),p=u.split("+",1)[0],g=u.slice(p.length+1)+e.port?":"+e.port:"";for(const s of i)s.postMessage({channel:"load-resource",id:h,path:e.pathname,scheme:p,authority:g,query:e.search.replace(/^\?/,""),ifNoneMatch:a?.headers.get("ETag")});return c.then(s=>r(s,a))}async function processLocalhostRequest(t,e){const o=await sw.clients.get(t.clientId);if(!o)return fetch(t.request);const n=getWebviewIdForClient(o);if(!n)return console.error("Could not resolve webview id"),fetch(t.request);const r=e.origin,i=async c=>{if(!c)return fetch(t.request);const u=t.request.url.replace(new RegExp(`^${e.origin}(/|$)`),`${c}$1`);return new Response(null,{status:302,headers:{Location:u}})},l=await getOuterIframeClient(n);if(!l.length)return console.log("Could not find parent client for request"),notFound();const{requestId:a,promise:h}=localhostRequestStore.create();for(const c of l)c.postMessage({channel:"load-localhost",origin:r,id:a});return h.then(i)}function getWebviewIdForClient(t){return new URL(t.url).searchParams.get("id")}async function getOuterIframeClient(t){return(await sw.clients.matchAll({includeUncontrolled:!0})).filter(o=>{const n=new URL(o.url);return(n.pathname===`${rootPath}/`||n.pathname===`${rootPath}/index.html`||n.pathname===`${rootPath}/electron-browser-index.html`)&&n.searchParams.get("id")===t})}

//# sourceMappingURL=service-worker.js.map
