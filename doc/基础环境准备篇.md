# 基础环境准备篇

> 工欲善其事，必先利其器！

​ 环境准备是第一步也是低代码平台部署最重要的一步，如果环境准备不完备，下面部署工作会更加头痛，问题层出不穷。因此，如果想避免不必要的因为部署环境不一致导致的各种问题，大家在准备 flyfish 基础环境的时候要尽可能与文档的中基础环境保持一致。

<img src="./images/flowchart.jpg" width='800' >

### 一、基础环境

| 环境依赖 | 版本   | 说明          |
| -------- | ------ | ------------- |
| CentOS   | 7.6    |               |
| Node.js  | 14.9.0 | 推荐@12、@14  |
| MySQL    | 5.7.25 | >=5.6.38 即可 |
| Redis    | 5.0    | >= 4.0.8 即可 |
| pm2      | 5.1.2  | node 进程守护 |
| nvm      | 0.38.0 | node 版本管理 |

### 二、资源需求

> 资源需求经供参考，用户可根据自己的需求去定制服务器配置。

| 资源 | 说明  |
| ---- | ----- |
| CPU  | 8Core |
| 内存 | 16G   |
| 磁盘 | 200G  |

### 三、基础环境准备

1. Node.js 安装部署（以node@14.9.0为例）

> node.js 下载地址：https://nodejs.org/dist/

```bash
# 创建安装目录
mkdir -p /usr/local/node/

# 1.下载nodejs的tar包
wget https://nodejs.org/dist/v14.9.0/node-v14.9.0-linux-x64.tar.xz

# 解压并删除安装包
tar -xvf node-v14.9.0-linux-x64.tar.xz
rm -rf node-v14.9.0-linux-x64.tar.xz

# 配置全局环境
vim /etc/profile

# 将变量配置添加到/etc/profile尾部
export NODE_HOME=/usr/local/node/node-v14.9.0-linux-x64
export PATH=$NODE_HOME/bin:$PATH

# 使/etc/profile生效
source /etc/profile

# 验证
[root@localhost ~] node -v
v14.9.0

# 切换 npm 镜像源为淘宝镜像
npm config set registry https://registry.npm.taobao.org

```

⚠️ 注意！

如果环境上已有 nodejs 但是版本和文档不一致且当前 nodejs 版本无法正常运行 flyfish，建议您使用 nvm 来管理 nodejs 版本。

2. nvm（以nvm@0.38.0为例）

```bash
# 下载 nvm 源码
git clone https://gitee.com/mirrors/nvm

# 执行 nvm.sh 文件
source nvm/nvm.sh

# 验证执行是否成功
nvm --version

# 切换镜像
NVM_NODEJS_ORG_MIRROR=https://npm.taobao.org/mirrors/node

# 安装 nodejs
nvm install --lts （最新稳定版）
nvm install v14.9.0 （指定版本）

# 指定默认版本nodejs（否则下登录会找不到nodejs）
nvm alias default v14.9.0

```

3. pm2 (以pm2@5.1.2为例)

> flyfish 已集成 pm2 启动服务的命令，这里只做简单说明。

```bash
# 安装 pm2
npm install -g pm2@5.1.2

# 启动指定服务并命名为 flyfish_solution_platform
pm2 start dev.js -n 'flyfish_solution_platform'

# 停止指定服务
pm2 stop flyfish_solution_platform

# 停止所有服务
pm2 stop all

```

4. MySQL 部署（以mysql@5.7为例）

> MySQL 下载地址：https://downloads.mysql.com/archives/community/

**方案一：**

```bash
# 安装依赖
yum install -y gcc gcc-c++ cmake ncurses ncurses-devel bison
yum install -y ncurses-devel zlib-devel cmake make gcc gcc-c++

# 下载mysql源码（这里使用的是mysql-5.7）
wget https://cdn.mysql.com//archives/mysql-5.7/mysql-boost-5.7.25.tar.gz

# 添加用户
useradd -s /sbin/nologin mysql

# 建立所需目录并更改所有者为mysql
mkdir -p /data/mysql/data
chown -R mysql:mysql /data/mysql

# 将下载好的mysql 解压到/usr/local/mysql目录下
tar -zxvf mysql-boost-5.7.25.tar.gz -C /usr/local/mysql/

# 切换到mysql下载目录下，编译安装
cd /usr/local/mysql/mysql-5.7.25
cmake -DDEFAULT_CHARSET=utf8 -DDEFAULT_COLLATION=utf8_general_ci -DWITH_BOOST=boost
make && make install

# 编辑 /etc/my.cnf（如果没有则创建）
# 把安装目录用户和组更改为mysql
chown -R mysql:mysql mysql

# 把数据库数据目录用户和组更改为mysql（数据库数据目录：/data/mysql/data），方法同上!
# 注：/data/mysql/data目录下一定要为空才行
# 初始化mysql
./mysqld --initialize-insecure --user=mysql --basedir=/usr/local/mysql --datadir=/data/mysql/data

# 注:到这一步很容易出问题，在初始化的时候一定要加上面的参数，而且在执行这一步操作前 /data/mysql/data 这个目录必须是空的；在这里指定的basedir 和 datadir 目录必须要和 /etc/my.cnf 配置的目录一致才行。
# 拷贝可执行配置文件
cd /usr/local/mysql/support-files
cp mysql.server /etc/init.d/mysqld

# 启动mysql
service mysqld start

# 测试连接：无需密码即可连接成功
./mysql -hlocalhost -uroot -p

# 修改环境变量:在/etc/profile 中新增一行
vim /etc/profile
PATH=/usr/local/mysql/bin:$PATH

# 保存退出
source /etc/profile

# 设置开机自启动
systemctl enable mysqld

# 修改mysql密码
mysql> set global validate_password_policy=0;
mysql> set global validate_password_length=1;

# 修改之后只有6个字符的最小长度限制，接着修改密码‘密码以123456为例
mysql> ALTER USER 'root'@'localhost' IDENTIFIED BY '123456';

# 允许远程连接
GRANT ALL PRIVILEGES ON *.* TO 'root'@'%' IDENTIFIED BY '123456' WITH GRANT OPTION;

```

**方案二：**

```bash
# 下载repo配置文件
wget https://dev.mysql.com/get/mysql57-community-release-el7-9.noarch.rpm

# repo安装
rpm -ivh mysql57-community-release-el7-9.noarch.rpm

```

```bash
# 配置mysql安装镜像
cd /etc/yum.repos.d

# 修改各镜像repo配置
# 如果有就直接复制替换镜像，没有就新建
touch mysql-community.repo mysql-community-source.repo

```

**mysql-community.repo 配置推荐使用 OpenTuna**

```bash
# Enable to use MySQL 5.5
[mysql55-community]
name=MySQL 5.5 Community Server
baseurl=https://opentuna.cn/mysql/yum/mysql-5.5-community-el7-$basearch/
enabled=0
gpgcheck=1
gpgkey=https://repo.mysql.com/RPM-GPG-KEY-mysql

# Enable to use MySQL 5.6
[mysql56-community]
name=MySQL 5.6 Community Server
baseurl=https://opentuna.cn/mysql/yum/mysql-5.6-community-el7-$basearch/
enabled=0
gpgcheck=1
gpgkey=https://repo.mysql.com/RPM-GPG-KEY-mysql

# Enable to use MySQL 5.7
[mysql57-community]
name=MySQL 5.7 Community Server
baseurl=https://opentuna.cn/mysql/yum/mysql-5.7-community-el7-$basearch/
enabled=1
gpgcheck=1
gpgkey=https://repo.mysql.com/RPM-GPG-KEY-mysql

[mysql80-community]
name=MySQL 8.0 Community Server
baseurl=https://opentuna.cn/mysql/yum/mysql-8.0-community-el7-$basearch/
enabled=0
gpgcheck=1
gpgkey=https://repo.mysql.com/RPM-GPG-KEY-mysql

[mysql-connectors-community]
name=MySQL Connectors Community
baseurl=https://opentuna.cn/mysql/yum/mysql-connectors-community-el7-$basearch/
enabled=1
gpgcheck=1
gpgkey=https://repo.mysql.com/RPM-GPG-KEY-mysql

[mysql-tools-community]
name=MySQL Tools Community
baseurl=https://opentuna.cn/mysql/yum/mysql-tools-community-el7-$basearch/
enabled=1
gpgcheck=1
gpgkey=https://repo.mysql.com/RPM-GPG-KEY-mysql

[mysql-tools-preview]
name=MySQL Tools Preview
baseurl=https://opentuna.cn/mysql/yum/mysql-tools-preview/el/7/$basearch/
enabled=0
gpgcheck=1
gpgkey=https://repo.mysql.com/RPM-GPG-KEY-mysql

[mysql-cluster-7.5-community]
name=MySQL Cluster 7.5 Community
baseurl=https://opentuna.cn/mysql/yum/mysql-cluster-7.5-community-el7-$basearch/
enabled=0
gpgcheck=1
gpgkey=https://repo.mysql.com/RPM-GPG-KEY-mysql

[mysql-cluster-7.6-community]
name=MySQL Cluster 7.6 Community
baseurl=https://opentuna.cn/mysql/yum/mysql-cluster-7.6-community-el7-$basearch/
enabled=0
gpgcheck=1
gpgkey=https://repo.mysql.com/RPM-GPG-KEY-mysql

[mysql-cluster-8.0-community]
name=MySQL Cluster 8.0 Community
baseurl=https://opentuna.cn/mysql/yum/mysql-cluster-8.0-community-el7-$basearch/
enabled=0
gpgcheck=1
gpgkey=https://repo.mysql.com/RPM-GPG-KEY-mysql
```

**mysql-community-source.repo 配置推荐使用 OpenTuna**

```bash
[mysql55-community-source]
name=MySQL 5.5 Community Server - Source
baseurl=https://opentuna.cn/mysql/yum/mysql-5.5-community-el7-SRPMS
enabled=0
gpgcheck=1
gpgkey=https://repo.mysql.com/RPM-GPG-KEY-mysql

[mysql56-community-source]
name=MySQL 5.6 Community Server - Source
baseurl=https://opentuna.cn/mysql/yum/mysql-5.6-community-el7-SRPMS
enabled=0
gpgcheck=1
gpgkey=https://repo.mysql.com/RPM-GPG-KEY-mysql

[mysql57-community-source]
name=MySQL 5.7 Community Server - Source
baseurl=https://opentuna.cn/mysql/yum/mysql-5.7-community-el7-SRPMS
enabled=0
gpgcheck=1
gpgkey=https://repo.mysql.com/RPM-GPG-KEY-mysql

[mysql80-community-source]
name=MySQL 8.0 Community Server - Source
baseurl=https://opentuna.cn/mysql/yum/mysql-8.0-community-el7-SRPMS
enabled=0
gpgcheck=1
gpgkey=https://repo.mysql.com/RPM-GPG-KEY-mysql

[mysql-connectors-community-source]
name=MySQL Connectors Community - Source
baseurl=https://opentuna.cn/mysql/yum/mysql-connectors-community-el7-SRPMS
enabled=0
gpgcheck=1
gpgkey=https://repo.mysql.com/RPM-GPG-KEY-mysql

[mysql-tools-community-source]
name=MySQL Tools Community - Source
baseurl=https://opentuna.cn/mysql/yum/mysql-tools-community-el7-SRPMS
enabled=0
gpgcheck=1
gpgkey=https://repo.mysql.com/RPM-GPG-KEY-mysql

[mysql-tools-preview-source]
name=MySQL Tools Preview - Source
baseurl=https://opentuna.cn/mysql/yum/mysql-tools-preview/el/7/SRPMS
enabled=0
gpgcheck=1
gpgkey=https://repo.mysql.com/RPM-GPG-KEY-mysql

[mysql-cluster-7.5-community-source]
name=MySQL Cluster 7.5 Community - Source
baseurl=https://opentuna.cn/mysql/yum/mysql-cluster-7.5-community-el7-SRPMS
enabled=0
gpgcheck=1
gpgkey=https://repo.mysql.com/RPM-GPG-KEY-mysql

[mysql-cluster-7.6-community-source]
name=MySQL Cluster 7.6 Community - Source
baseurl=https://opentuna.cn/mysql/yum/mysql-cluster-7.6-community-el7-SRPMS
enabled=0
gpgcheck=1
gpgkey=https://repo.mysql.com/RPM-GPG-KEY-mysql

[mysql-cluster-8.0-community-source]
name=MySQL Cluster 8.0 Community - Source
baseurl=https://opentuna.cn/mysql/yum/mysql-cluster-8.0-community-el7-SRPMS
enabled=0
gpgcheck=1
gpgkey=https://repo.mysql.com/RPM-GPG-KEY-mysql
```

```bash
# 安装mysqlserver
yum install mysql-community-server --nogpgcheck

# 验证是否安装成功
mysql --version
mysql  Ver 14.14 Distrib 5.7.37, for Linux (x86_64) using  EditLine wrapper

# 启动mysql
systemctl start mysqld.service

# 查看状态
systemctl status mysqld.service

# 设置开机自启动
systemctl enable mysqld

# 查看临时密码
grep "password" /var/log/mysqld.log
2022-04-09T14:29:39.144660Z 1 [Note] A temporary password is generated for root@localhost: %PiQCYVSk69(

# 进入数据库
mysql -uroot -p

# 修改mysql密码
set global validate_password_policy=0;
set global validate_password_length=1;

# 修改之后只有6个字符的最小长度限制，接着修改密码‘密码以123456为例
ALTER USER 'root'@'localhost' IDENTIFIED BY '123456';

# 允许远程连接
GRANT ALL PRIVILEGES ON *.* TO 'root'@'%' IDENTIFIED BY '123456' WITH GRANT OPTION;

```

**⚠️ 注意！**

```bash
# 注意!若是更改mysql密码时报错：mysql1193 HY000,MySQL ERROR 1193 (HY000): Unknown system variable 'validate_password_policy'

# 解决方法：
# 原因
# 未开启密码校验插件。
# 查看设置
# 查看变量中是否有密码校验。
SHOW VARIABLES LIKE 'validate_password%';

# 查看插件中是否有校验类插件。
select plugin_name, plugin_status from information_schema.plugins where plugin_name like 'validate%';

# 返回空集合
mysql> SHOW VARIABLES LIKE 'validate_password%';
Empty set (0.00 sec)
mysql> select plugin_name, plugin_status from information_schema.plugins where plugin_name like 'validate%';
Empty set (0.00 sec)

# 解决方法
# 安装插件(在MySQL shell中)
install plugin validate_password soname 'validate_password.so';

# 查看是否安装成功
mysql> select plugin_name, plugin_status from information_schema.plugins where plugin_name like 'validate%';
+-------------------+---------------+
| plugin_name | plugin_status |
+-------------------+---------------+
| validate_password | ACTIVE |
+-------------------+---------------+
1 row in set (0.01 sec)

# 查看相关变量
mysql> SHOW VARIABLES LIKE 'validate_password%';
+--------------------------------------+--------+
| Variable_name | Value |
+--------------------------------------+--------+
| validate_password_check_user_name | OFF |
| validate_password_dictionary_file | |
| validate_password_length | 8 |
| validate_password_mixed_case_count | 1 |
| validate_password_number_count | 1 |
| validate_password_policy | MEDIUM |
| validate_password_special_char_count | 1 |
+--------------------------------------+--------+
7 rows in set (0.00 sec)

```

5. Redis 部署（以Redis@5.0为例）

> Redis 下载地址：https://redis.io/download/#redis-downloads

```bash
# 安装依赖
yum install -y gcc g++ gcc-c++ make
yum install -y tcl

# 下载、解压、编译
wget https://download.redis.io/releases/redis-5.0.0.tar.gz
tar -zxvf redis-5.0.0.tar.gz
cd redis-5.0.0
make
cd src/
make install

# 启动redis服务
./redis-server

# 设置后台启动redis：首先编辑conf文件，将daemonize属性改为yes（表明需要在后台运行）
# 配置redis可以远程
# 修改配置文件redis.conf：将bind 127.0.0.1注释， 将protected-mode修改为no
cd ../
vim redis.conf

daemonize yes

# 再次启动redis服务，并指定启动服务配置文件
cd src/
./redis-server ../redis.conf

# 重启redis
pkill redis-server

cd src/

./redis-server ../redis.conf

```
